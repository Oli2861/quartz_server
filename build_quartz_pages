#!/bin/bash

echo "----- STARTING to build quartz pages ------"

function get_contents() {
    URL=$1
    REPO_DIR=$2
    CONTENT_DIR=$3

    if [[ "$(ls $REPO_DIR | wc -l)" -eq 0 ]]; then
        echo "Repository doesnt exist yet --> cloning $URL"
        git clone $URL $REPO_DIR
    else 
        echo "Repository exists --> pulling $QUARTZ_CONTENT_REPOSITORY_URL"
        cd $REPO_DIR && git pull
    fi

    cp -Rp $REPO_DIR/* $CONTENT_DIR
}

function build_contents() {
    QUARTZ_DIR=$1
    OUTPUT_DIR=$2

    cd $QUARTZ_DIR && \
    npx quartz build -o current_quartz_build && \
    cp -TR current_quartz_build $OUTPUT_DIR  && \
    chown -R www-data:www-data $OUTPUT_DIR && \
    echo "----- SUCCESS: Built quartz pages to $OUTPUT_DIR ------" && exit 0
    echo "----- FAILED: To build quartz pages ------" && exit 1
}

get_contents $QUARTZ_CONTENT_REPOSITORY_URL /app/repository /app/quartz/content
build_contents /app/quartz /var/www/quartz/public

